<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>10万粒子银河拖尾 · 绝对稳定版</title>
<style>
  body { margin:0; overflow:hidden; background:#000; touch-action:none; }
  #ui {
    position:fixed; top:15px; left:15px; z-index:999; color:#0ff; font-family:Arial;
    background:rgba(0,0,0,0.75); padding:18px 25px; border-radius:18px;
    backdrop-filter:blur(15px); border:2px solid #0ff; box-shadow:0 0 40px rgba(0,255,255,0.5);
    user-select:none;
  }
  button {
    margin:5px; padding:10px 18px; border:none; border-radius:12px; cursor:pointer;
    font-weight:bold; transition:all 0.3s;
  }
  button:hover { transform:scale(1.12); box-shadow:0 0 25px #0ff; }
  .btn-active { background:#00ffcc !important; color:#000 !important; }
</style>
</head>
<body>

<button onclick="startShow()" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  padding:25px 60px; font-size:28px; background:#00ffcc; color:#000; border:none; border-radius:25px;
  cursor:pointer; box-shadow:0 0 80px #00ffcc; z-index:99999; font-weight:bold;">
  点击开启 10万粒子银河拖尾（绝对稳定版）
</button>

<div id="container" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000;"></div>

<script>
function startShow() {
  document.querySelector('button').remove();
  document.getElementById('container').style.display = 'block';

  const container = document.getElementById('container');
  container.innerHTML = `
    <canvas id="c" style="position:absolute;top:0;left:0;"></canvas>
    <div id="ui">
      <div style="font-size:28px;color:#0ff;text-shadow:0 0 20px #0ff;margin-bottom:10px;">10万粒子 · 银河拖尾</div>
      <button class="btn-active" onclick="setShape('heart')">爱心</button>
      <button onclick="setShape('planet')">土星</button>
      <button onclick="setShape('flower')">樱花</button>
      <button onclick="setShape('spiral')">螺旋</button>
      <button onclick="setShape('wave')">音波</button>
      <button onclick="explode()">爆炸</button>
      <button onclick="changeColor()">换色</button>
      <div style="margin-top:12px;color:#0f0;">
        粒子：<b>100,000</b> | 大小：<span id="size">1.0</span>x | 拖动=缩放
      </div>
    </div>
  `;

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  canvas.width = innerWidth;
  canvas.height = innerHeight;

  const COUNT = 100000;
  const particles = [];
  let mouseX = innerWidth / 2;
  let mouseY = innerHeight / 2;
  let scale = 1;
  let hue = 180;
  let targetShape = 'heart';
  let exploding = false;

  // 分批初始化粒子（关键修复！防止卡死）
  let initialized = 0;
  function initBatch() {
    const batchSize = 5000;
    const end = Math.min(initialized + batchSize, COUNT);
    for(let i = initialized; i < end; i++) {
      particles.push({
        x: innerWidth/2 + (Math.random()-0.5)*1000,
        y: innerHeight/2 + (Math.random()-0.5)*1000,
        tx: 0, ty: 0,
        vx: 0, vy: 0
      });
    }
    initialized = end;
    if(initialized < COUNT) {
      requestAnimationFrame(initBatch);
    } else {
      generateShape('heart'); // 初始化完成后再生成形状
    }
  }

  function generateShape(type) {
    if(particles.length === 0) return;
    targetShape = type;
    const centerX = innerWidth / 2;
    const centerY = innerHeight / 2;

    particles.forEach((p, i) => {
      const t = i / particles.length;
      let x = 0, y = 0;

      if(type === 'heart') {
        const a = t * Math.PI * 2;
        x = 16 * Math.pow(Math.sin(a), 3);
        y = -(13 * Math.cos(a) - 5 * Math.cos(2*a) - 2 * Math.cos(3*a) - Math.cos(4*a));
        x *= 22; y *= 22;
      }
      else if(type === 'planet') {
        const a = Math.random() * Math.PI * 2;
        const r = i < particles.length * 0.6 ? 200 : 380 + Math.random() * 200;
        x = Math.cos(a) * r;
        y = Math.sin(a) * r * 0.15;
      }
      else if(type === 'flower') {
        const a = t * 16 * Math.PI;
        const r = 280 * Math.cos(7 * a);
        x = r * Math.cos(a);
        y = r * Math.sin(a);
      }
      else if(type === 'spiral') {
        const a = t * 35;
        const r = a * 10;
        x = r * Math.cos(a);
        y = r * Math.sin(a);
      }
      else if(type === 'wave') {
        x = (i % 400 - 200) * 5;
        y = Math.sin(i * 0.02) * 300 + (Math.floor(i / 400) - 125) * 25;
      }

      p.tx = centerX + x;
      p.ty = centerY + y;
    });

    document.querySelectorAll('#ui button').forEach(b => {
      b.classList.remove('btn-active');
      if(b.onclick.toString().includes(type)) b.classList.add('btn-active');
    });
  }

  function explode() {
    exploding = true;
    particles.forEach(p => {
      const a = Math.random() * Math.PI * 2;
      const f = 15 + Math.random() * 25;
      p.vx = Math.cos(a) * f;
      p.vy = Math.sin(a) * f;
    });
    setTimeout(() => exploding = false, 1800);
  }

  window.setShape = generateShape;
  window.explode = explode;
  window.changeColor = () => hue = (hue + 75) % 360;

  // 鼠标/触屏
  let dragging = false;
  canvas.addEventListener('pointerdown', () => dragging = true);
  canvas.addEventListener('pointerup', () => dragging = false);
  canvas.addEventListener('pointermove', e => {
    mouseX = e.clientX;
    mouseY = e.clientY;
    if(dragging) {
      scale = Math.max(0.15, Math.min(6, scale - e.movementY * 0.025));
      document.getElementById('size').textContent = scale.toFixed(2);
    }
  });

  // 开始分批初始化
  initBatch();

  // 主循环
  function animate() {
    ctx.fillStyle = 'rgba(0,0,0,0.04)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    particles.forEach(p => {
      let tx = p.tx;
      let ty = p.ty;

      if(exploding) {
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.97;
        p.vy *= 0.97;
      } else {
        const dx = mouseX - p.x;
        const dy = mouseY - p.y;
        const dist = Math.hypot(dx, dy);
        if(dist < 400) {
          const force = (400 - dist) / 400;
          tx += dx * force * 1.5;
          ty += dy * force * 1.5;
        }
        p.x += (tx * scale - p.x) * 0.1;
        p.y += (ty * scale - p.y) * 0.1;
      }

      const distToMouse = Math.hypot(p.x - mouseX, p.y - mouseY);
      const glow = distToMouse < 250 ? (1 - distToMouse/250) : 0;
      const size = 1.5 + glow * 6;

      ctx.fillStyle = `hsla(${hue + glow*100},100%,70%,${0.7 + glow*0.3})`;
      ctx.fillRect(p.x - size/2, p.y - size/2, size, size);
    });

    requestAnimationFrame(animate);
  }
  animate();

  window.onresize = () => {
    canvas.width = innerWidth;
    canvas.height = innerHeight;
  };
}
</script>
</body>
</html>